# Epic 5 Retrospective — Photo Gallery

**Date:** 2026-02-09
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 5 — Photo Gallery
**Status:** Complete (2/2 stories done)

## Epic Summary

Epic 5 delivered the complete photo gallery feature for HomeCafe, covering FR48-FR50. The epic introduced a Photo aggregate with upload via the shared presigned URL infrastructure (Epic 1), paginated browsing, full-size viewing, and deletion with R2 storage cleanup. The simplest epic to date: 2 stories, clean execution, zero blockers.

### Delivery Metrics

- Stories completed: 2/2 (100%)
- Tests added: 16 new tests (287 → 303 total)
- Code reviews: 2 adversarial reviews, 11 issues found (3 HIGH, 4 MEDIUM, 4 LOW), all fixed
- Blockers: 0
- Production incidents: 0

### Stories Delivered

| Story | Description | Tests Added | Files Created/Modified | Key Achievement |
|---|---|---|---|---|
| 5.1 | Upload Photos to Gallery | 6 | 17 created, 3 modified | Photo aggregate, DB schema, 3-step presigned URL upload flow, retry on failure |
| 5.2 | Browse & Delete Gallery Photos | 10 | 8 created, 6 modified | Delete with R2 cleanup, pagination, photo view modal, empty states |

## What Went Well

1. **Cleanest epic delivered** — 2/2 stories, 0 blockers, 0 production incidents, 100% FR coverage (FR48-50). Smallest and most efficient epic in the project.

2. **Exemplary infrastructure reuse** — Story 5.1 reused the entire upload infrastructure from Epic 1 (Story 1.1) without recreating a single component. The `/api/v1/upload` endpoint with `context: 'gallery'` worked out of the box. Zero upload duplication.

3. **Elegant Photo aggregate design** — Immutable aggregate (create-only, no updatedAt). Simple properties: userId, url, filename, mimeType, size, caption (Option). The right complexity for the right domain — a photo is created or deleted, nothing more.

4. **Previous retro follow-through: 4/5 (80%)** — Up from 2/5 (40%) in Epic 3→4 transition. The key driver was action item #4 from Epic 4 retro: integrating retro items directly into story tasks instead of standalone action items.

5. **Checklists embedded in stories consistently followed** — Security checklist, data integrity checklist, code duplication checklist all present and followed in both stories. The server→client conversion check (Epic 4 retro action #3) was applied correctly in 5.2.

6. **Delete flow design: R2 first, then DB** — Deleting from R2 storage BEFORE the DB record ensures no orphaned files. If DB delete fails after R2 delete, the photo was being deleted anyway (acceptable). Sound data integrity reasoning.

7. **markDeleted() pattern** — When `addEvent()` couldn't be called from the use case (protected access), the team added a `markDeleted()` method on the Photo aggregate. Clean encapsulation preserved.

## What Didn't Go Well

1. **HIGH severity issues found ONLY in code review — 5th consecutive epic** — 3 HIGHs across 2 stories: local `UploadedPhoto` type instead of shared `GalleryPhotoDto` (5.1-H2), `new URL()` without try/catch causing potential TypeError (5.2-HIGH), fetch errors silently swallowed in GalleryGrid (5.2-HIGH). The adversarial code review remains the sole safety net.

2. **Type duplication in both stories** — Story 5.1 created local `UploadedPhoto` interface (replaced by `GalleryPhotoDto`). Story 5.2 created local `GalleryData` interface (replaced by `GetUserGalleryOutputDto`). Pattern: dev agent creates local types instead of importing existing shared DTOs.

3. **GET endpoint missing in Story 5.1** — The story scope included "Simple grid of uploaded photos (fetch via CQRS query or basic GET)" but the dev agent implemented only the write path (POST). The M3+M4 code review fix added the CQRS query + GET endpoint. Users would have uploaded photos into a void.

4. **Silent error handling in 5.2** — GalleryGrid fetch failures were silently swallowed — no error state, no retry UI. Users would see an empty page with no indication of failure. Caught and fixed in code review.

5. **shadcn workaround in CLAUDE.md — 3rd epic not addressed** — The standalone action item from Epic 3 retro to document the shadcn import path fix in CLAUDE.md was again not completed. Decision made during this retro: Axel will document it immediately post-retro.

## Key Insights

1. **Code review adversarial is our safety net and it works** — 5 consecutive epics, HIGHs caught every time, zero production incidents. The cost of review is far lower than the cost of a production bug. Team decision: continue this approach.

2. **Checklists in stories = followed. Standalone items = ignored.** — This pattern is now confirmed across 3 epics (3, 4, 5). The mechanism: dev agent follows what's IN the story context. External action items don't exist in the agent's context.

3. **New checklist needed: "Error handling visible"** — The silent fetch error in 5.2 introduces a new checklist item: "Does every client-side API call have a visible error state?" Simple to verify, prevents UX blind spots.

4. **Infrastructure reuse is the reward of good architecture** — The upload endpoint designed in Epic 1 was used unchanged in Epic 5. The upfront investment in shared infrastructure pays dividends across epics.

5. **Immutable aggregates simplify everything** — Photo (create/delete only) had zero design complexity vs Board (Epic 4) with its CRUD operations, entity relationships, and drag-and-drop state. Match complexity to domain needs.

## Previous Retrospective Follow-Through

### Epic 4 Action Items Status

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Add code duplication checklist to stories | ✅ Completed | Both stories 5.1 and 5.2 include "Code Duplication Checklist" section |
| 2 | Document shadcn/ui workaround in CLAUDE.md | ❌ Not Addressed | CLAUDE.md still lacks section. Workaround documented in each story individually. Resolved: Axel will do it immediately post-retro. |
| 3 | Add server→client conversion check to Security Checklist | ✅ Completed | Story 5.1: "If page becomes client component, verify auth guard in layout.tsx." Applied correctly in 5.2 gallery-client.tsx conversion. |
| 4 | Integrate retro action items into story tasks | ✅ Completed | Both stories reference Epic 4 learnings, embed checklists, include "Previous Story Intelligence" sections |
| 5 | IEventDispatcher: Accept deferral to Epic 7 | ✅ Completed | Both stories explicitly state: "IEventDispatcher NOT wired — deferred to Epic 7." PhotoUploadedEvent and PhotoDeletedEvent added via addEvent(). No ambiguity. |

**Score: 4/5 completed, 1 not addressed (resolved this retro)**

### Epic 4 Technical Debt Status

| # | Item | Epic 5 Status | Impact |
|---|---|---|---|
| 1 | IEventDispatcher not wired | Unchanged — more events added (PhotoUploadedEvent, PhotoDeletedEvent) | Events accumulating, dispatch deferred to Epic 7 |
| 2 | db:push not executed | Unchanged — photo table schema added | 5 epics of schema migrations not pushed |
| 3 | i18n absent | Unchanged | UI text still in English |
| 4 | `<img>` instead of `<Image>` | Unchanged — confirmed as project pattern in 5.1 review | Pre-existing pattern |
| 5 | Biome warnings | Unchanged | ~40 pre-existing warnings |
| 6 | shadcn import paths | Unchanged — still manual fix | Tooling issue, being documented in CLAUDE.md |

## Technical Debt

| # | Item | Severity | Description |
|---|---|---|---|
| 1 | IEventDispatcher not wired | High | Domain events added via addEvent() since Epic 1 (5 epics). PhotoUploadedEvent, PhotoDeletedEvent added. Deferred to Epic 7. |
| 2 | db:push not executed | High | Database schema migrations generated but never pushed (5 epics). All schemas including new photo table. |
| 3 | i18n absent | Low | UI text in English. Deferred to dedicated story. |
| 4 | `<img>` instead of `<Image>` | Low | Pre-existing pattern using raw img tags. Confirmed as project convention. |
| 5 | Biome warnings | Low | ~40 pre-existing warnings (dangerouslySetInnerHTML, noNonNullAssertion in tests). |

## Action Items

| # | Action | Owner | Timeline | Success Criteria |
|---|---|---|---|---|
| 1 | Add "error handling visible" checklist to stories | Bob (SM) | Before Epic 6 | Every story includes: "Does every client-side API call have a visible error state + retry if applicable?" |
| 2 | Document shadcn/ui workaround in CLAUDE.md | Axel (Project Lead) | Immediately post-retro | CLAUDE.md section with: install command, import path fix pattern, typical impacted files |
| 3 | Maintain retro item integration in story tasks | Bob (SM) | Ongoing | Zero standalone action items — all embedded in stories |

## Epic 6 Preparation

### Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Upload infrastructure (Epic 1) | ✅ Ready | `context: 'moodboard'` already supported by UploadContext VO |
| Aggregate + Entity pattern | ✅ Ready | Proven in Epic 4 (Board/Column/Card) |
| CRUD + CQRS patterns | ✅ Ready | Mature across 5 epics |
| DI / Tests / Biome | ✅ Ready | 303 tests baseline, zero failures |
| Checklists | ✅ Ready | Security, data integrity, duplication, error handling (new) |
| Dependencies on Epic 5 | None | Fully standalone |
| Blockers | None | Zero blockers identified |

### Dependencies on Epic 5

None. Epic 6 (Moodboard) is fully standalone. It shares the upload infrastructure from Epic 1 but has no dependency on Epic 5 gallery code.

### Preparation Tasks

1. **Document shadcn workaround in CLAUDE.md** — Axel, immediately post-retro
2. **Add error handling visible checklist** — Bob, embed in Epic 6 story templates

### No Significant Discoveries

Nothing from Epic 5 fundamentally changes the plan for Epic 6. The architecture is sound, patterns are proven, and the team is well-positioned.

## Team Participants

- Bob (Scrum Master) — Facilitation
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical depth
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Fresh perspective
- Axel (Project Lead) — Oversight and direction

## Retrospective Verdict

Epic 5 was the cleanest and most efficient epic to date: 2 stories, 16 tests, 25 files created, zero blockers, zero production incidents. The Photo aggregate's immutable design was the right match for the domain. Infrastructure reuse from Epic 1 was exemplary. Retro follow-through improved dramatically (80% vs 40%). The pattern of HIGH severity issues found only in code review continues (5th consecutive epic), but the team consciously accepts the code review as the primary safety net — it catches every HIGH and has prevented all production incidents. A new "error handling visible" checklist addresses the silent failure pattern discovered in Story 5.2. Epic 6 (Moodboard) has zero blockers and the team is ready to proceed.
