# Epic 2 Retrospective — Social Feed & Reactions

**Date:** 2026-02-08
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 2 — Social Feed & Reactions
**Status:** Complete (2/2 stories done)

## Epic Summary

Epic 2 delivered the social feed and post reactions features for HomeCafe, covering FR27-FR29 (3 functional requirements). The epic included browsing friends' public feed with pagination and a post reaction system with toggle behavior and real-time count updates.

### Delivery Metrics

- Stories completed: 2/2 (100%)
- Tests added: 19 new BDD tests (147 → 166 total)
- Code reviews: 2 adversarial reviews, all HIGH/MEDIUM issues resolved
- Blockers: 1 (db:push — database not running locally, carried from Epic 1)
- Production incidents: 0

### Stories Delivered

| Story | Description | Tests Added | Key Achievement |
|---|---|---|---|
| 2.1 | Browse Friends' Public Feed | 8 | Friend-based access control pattern, CQRS feed query, zero-error first pass |
| 2.2 | React to Posts & View Reactions | 11 | Post reactions via WatchedList, toggle pattern, SQL subqueries, access control helper |

## What Went Well

1. **Golden reference pattern (Story 2.2)** — Documenting a complete mapping table (chat source file → post target file → adaptation needed) enabled the entire reaction system to be implemented with zero structural errors. This pattern should be standard practice for any "adapt existing pattern" stories.

2. **Zero-error first pass (Story 2.1)** — Story 2.1 was implemented completely without any debug cycles. All 8 tests passed on first run. This demonstrates that Previous Story Intelligence sections are effectively transmitting lessons between stories.

3. **CQRS query pattern maturity** — The CQRS query pattern (direct Drizzle queries for pure reads) is now second nature. Feed query, reactions query, journal query — all implemented correctly without hesitation. No unnecessary Use Case or DI ceremony for reads.

4. **Friend-based access control pattern established** — The architecture "Important Gap" identified in Epic 1 retrospective was fully resolved. The pattern (query friendRequest → extract friend IDs → inArray filter) is documented and reusable across all social features.

5. **Epic 1 action items applied (4/6)** — Explicit type annotations (item 1), imperative isSome/unwrap pattern (item 2), Zod safeParse on all inputs (item 4) were consistently applied throughout Epic 2 with measurable positive impact: zero type inference errors, systematic input validation.

6. **Test suite integrity** — When Story 2.2 added `reactions` to `IPostProps`, existing tests for `get-post-detail` and `get-user-posts` correctly failed, requiring updates. This proves the test suite is properly coupled to domain interfaces and catches breaking changes.

## What Didn't Go Well

1. **Access control systematically missed in initial implementation** — Story 2.2 shipped reaction endpoints (POST and GET) without checking if the user had permission to access the post. This is the same category of issue as Story 1.5 (missing ownership check) and Story 1.2 (XSS). Security concerns are consistently only caught during adversarial code review, never during initial implementation.

2. **Dead code created then removed (recurring)** — `PostReactionType` class (Story 2.2) and `getFriendFeedInputDtoSchema` (Story 2.1) were created during implementation and flagged as unused in review. This continues the Epic 1 pattern (PostVisibility VO, PostImage VO, upload domain errors). Total: 5 instances across 7 stories in 2 epics.

3. **Two Epic 1 action items not addressed** — `getAuthenticatedUser()` extraction (item 6) was not done and the duplication grew with a new copy in `post-reactions.controller.ts`. `db:push` (item 5) remains unexecuted due to local PostgreSQL not running.

4. **Story specs sometimes too prescriptive** — Story 2.2 explicitly said "copy chat reaction pattern" which led to creating `PostReactionType` class (dead code). The dev followed instructions literally without questioning whether the class was needed. Specs should guide, not dictate verbatim copying.

## Key Insights

1. **Adversarial code reviews remain the only security safety net** — 2 epics, 7 stories, and every security issue was caught exclusively in review. This is not sustainable — security must shift left into the implementation process itself.

2. **Golden reference pattern is powerful but requires critical thinking** — Copying and adapting existing code dramatically reduces errors, but the dev must challenge each piece: "Is this component actually needed in the new context?" Blind copying propagates dead code.

3. **Previous Story Intelligence works** — The cumulative learning documented in each story file effectively prevents regression of known issues (type inference, async match, validation). This practice should continue.

4. **Standalone epics are refreshing** — Epic 3 (Mood Tracking) has zero dependencies on Epic 1 or 2, which eliminates blocking concerns and reduces preparation overhead. This is worth noting for future epic sequencing.

5. **Growing tech debt has compounding effects** — The `getAuthenticatedUser()` duplication (now in 10+ files) is not just a code smell — it prevents centralized improvements like integrated access control checks. Dana's observation that a shared auth utility could incorporate access control is evidence of compounding impact.

## Previous Retrospective Follow-Through

### Epic 1 Action Items Status

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Use explicit `: string` type annotation for VO.create() | Completed | Zero literal inference errors in Epic 2 |
| 2 | Prefer imperative `isSome()`/`unwrap()` over async `match()` | Completed | Consistent pattern in TogglePostReactionUseCase |
| 3 | Don't create VOs without domain logic justification | Partial | PostReactionType class created (dead code) then removed — story spec directed copying |
| 4 | Validate ALL controller inputs with Zod safeParse | Completed | All Epic 2 endpoints have input validation |
| 5 | Execute db:push when database is available | Not Addressed | PostgreSQL still not running locally |
| 6 | Extract getAuthenticatedUser() to shared utility | Not Addressed | Still duplicated, grew by 1 more copy |

**Score: 4/6 completed or in progress**

### Epic 1 Technical Debt Status

| # | Item | Epic 2 Status | Impact |
|---|---|---|---|
| 1 | IEventDispatcher not wired | Unchanged | No blocking — events added but not dispatched |
| 2 | `<img>` instead of `<Image>` | Unchanged | Feed cards use `<img>`, consistent pattern |
| 3 | `getAuthenticatedUser()` duplicated | Grew | Added 1 more copy in post-reactions.controller.ts |
| 4 | DATE() SQL timezone dependency | Unchanged | Not impacted by Epic 2 |
| 5 | db:push not executed | Unchanged | postReaction schema added but not pushed |
| 6 | Pre-existing code duplication 8.77% | Unchanged | No impact |

## Technical Debt

| # | Item | Severity | Description |
|---|---|---|---|
| 1 | IEventDispatcher not wired | Medium | Domain events added to aggregates via `addEvent()` but never dispatched. Deferred to Epic 7. |
| 2 | `<img>` instead of `<Image>` | Low | Pre-existing pattern using raw `<img>` tags for R2-hosted images. |
| 3 | `getAuthenticatedUser()` duplicated | Medium | Authentication helper copy-pasted across 10+ controller files. Growing with each story. Should be extracted to shared utility. |
| 4 | DATE() SQL timezone dependency | Low | PostgreSQL DATE() in journal/streak queries depends on server timezone. |
| 5 | db:push not executed | High | Database schema migrations generated but never pushed (local PostgreSQL not running). |
| 6 | Pre-existing code duplication 8.77% | Low | conversation.repository.ts and mappers duplication. |
| 7 | Biome warnings | Low | 40 pre-existing warnings (up from 39 in Epic 1). |

## Action Items

| # | Action | Owner | Timeline | Success Criteria |
|---|---|---|---|---|
| 1 | Add security/access control checklist to every new endpoint story | SM / Dev | Before Epic 3 | Every story file includes "Security Checklist" section with access control questions |
| 2 | Challenge specs before blind pattern copying | Dev | Ongoing | Zero dead code created and removed in review during Epic 3 |
| 3 | Extract `getAuthenticatedUser()` to shared utility | Dev | During Epic 3 | Single source of truth, zero duplication |
| 4 | Document friend-based access control pattern in CLAUDE.md | Dev | Before Epic 3 | Pattern documented with code example |
| 5 | Execute db:push when database is available | Dev | Before deployment | Schema applied to PostgreSQL |
| 6 | Research and select charting library for Epic 3 | Dev | Before Story 3.2 | Library chosen (recharts/chart.js/visx) with justification |

## Epic 3 Preparation

### Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Mood aggregate | Needs design | New domain: 9 categories, intensity slider, userId, timestamp |
| Charting library | Needs research | recharts vs chart.js vs visx for bar charts and trend lines |
| Dependencies on Epic 2 | None | Fully standalone epic |
| Technical infrastructure | Ready | Standard CQRS + Use Case patterns apply |
| Test infrastructure | Ready | Vitest + existing patterns sufficient |

### Dependencies on Epic 2

None. Epic 3 (Mood Tracking) is fully standalone with no dependencies on Epic 1 or Epic 2 work.

### Preparation Tasks

1. **Select charting library** — Research recharts, chart.js, visx for React 19 compatibility, bundle size, and feature coverage (bar charts, trend lines, responsive)
2. **Design Mood aggregate** — 9 categories (Calme, Enervement, Excitation, Anxiete, Tristesse, Bonheur, Ennui, Nervosite, Productivite), intensity (1-10 slider), userId, timestamp
3. **No critical blockers** — Epic 3 can start immediately

## Team Participants

- Bob (Scrum Master) — Facilitation
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical depth
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Fresh perspective
- Axel (Project Lead) — Oversight and direction

## Retrospective Verdict

Epic 2 was a compact, focused epic. 100% story completion in 2 stories, 19 new tests with zero regressions, zero production incidents. The golden reference pattern and Previous Story Intelligence proved their value. The recurring security/access control gap is the most important finding — addressed with a new security checklist action item. 4 of 6 Epic 1 action items were successfully applied, demonstrating the team's ability to learn and improve across epics. Epic 3 is fully standalone and can start immediately with minimal preparation (charting library selection is the only research needed).
