# Epic 1 Retrospective — Content Creation & Personal Journal

**Date:** 2026-02-08
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 1 — Content Creation & Personal Journal
**Status:** Complete (5/5 stories done)

## Epic Summary

Epic 1 delivered the core content creation and personal journal features for HomeCafe, covering FR18-FR26 (9 functional requirements). The epic included shared file upload infrastructure, post creation with rich text and images, post viewing and detail pages, journal view with streak counter, and post editing/deletion.

### Delivery Metrics

- Stories completed: 5/5 (100%)
- Tests added: 58 new BDD tests (89 → 147 total)
- Code reviews: 5 adversarial reviews, all HIGH/MEDIUM issues resolved
- Blockers: 1 (db:push — database not running locally)
- Production incidents: 0

### Stories Delivered

| Story | Description | Tests Added | Key Achievement |
|---|---|---|---|
| 1.1 | Shared File Upload Infrastructure | 15 | Centralized IStorageProvider, presigned R2 URLs |
| 1.2 | Create a Post | 13 | Post aggregate, Tiptap rich text, XSS prevention |
| 1.3 | View Posts & Post Detail | 13 | Paginated list, access control, content preview |
| 1.4 | Journal View & Streak Counter | 12 | CQRS query pattern, streak algorithm |
| 1.5 | Edit & Delete Posts | 20 | Single update() method, ownership verification |

## What Went Well

1. **Shared upload infrastructure (Story 1.1)** — Single `/api/v1/upload` endpoint with `context` parameter unblocks not just posts but also Gallery (Epic 5) and Moodboard (Epic 6). Strategic investment that pays forward.

2. **CQRS query pattern discovery (Story 1.4)** — For read-only operations (journal entries, streak counter), direct Drizzle queries bypassing DI + Use Case + Repository ceremony proved simpler and more performant. No DI registration, no ports, just pure functions.

3. **Adversarial code reviews** — Every story received a thorough code review that caught real issues. Critical XSS vulnerability in Story 1.2 and missing ownership verification in Story 1.5 were caught before reaching production.

4. **Previous Story Intelligence** — Each story file documented lessons from the previous story, creating cumulative learning. By Story 1.5, the dev had 4 stories of accumulated patterns, conventions, and pitfalls to reference.

5. **Aggregate refactoring (Story 1.5)** — Refactored from 3 individual update methods (`updateContent`, `updateVisibility`, `updateImages`) to a single `update(changes)` method that emits exactly 1 PostUpdatedEvent with 1 timestamp. Cleaner domain model.

6. **Consistent test growth** — 89 → 102 → 115 → 127 → 147 tests with zero regressions throughout the epic. BDD style at use case level with comprehensive error path coverage.

## What Didn't Go Well

1. **TypeScript type inference issues (3/5 stories)** — Recurring problems with literal type inference (`PostContent.create("literal")` returns `ValueObject<"literal">` instead of `PostContent`), async `match()` callback type narrowing (`Result.fail()` returns `Result<unknown>`), and union types in DI module conditional bindings.

2. **Validation gaps recurring across stories (3/5 stories)** — HTML whitespace bypass in PostContent VO (1.2), NaN/bounds on pagination params (1.3), deletePostController without Zod validation (1.5). Same category of issue appearing repeatedly despite previous story learnings.

3. **Security issues missed in initial implementation** — XSS vulnerability in Story 1.2 (no HTML sanitization) and missing ownership check in edit form (1.5) were only caught during code review, not during initial implementation. Both were high-severity.

4. **Dead code created then removed** — Upload domain errors (1.1) and PostVisibility/PostImage VOs (1.2) were created during implementation then flagged as unused dead code in review. Indicates over-engineering before validating need.

5. **Database push never executed** — `db:push` blocked throughout epic because local PostgreSQL database was not running. Migration file generated but never applied.

## Key Insights

1. **Adversarial code reviews are non-negotiable** — 2 security-critical issues (XSS, ownership) caught only in review. Without reviews, these would have shipped.

2. **TypeScript literal inference is a recurring trap** — Fix pattern: `const x: string = "literal"` before passing to ValueObject.create(). Document in CLAUDE.md.

3. **Async match() causes type inference problems** — Prefer imperative `isSome()`/`unwrap()` pattern over functional `match()` in async contexts. Result type narrowing doesn't work well in async callbacks.

4. **Create VOs only when domain logic exists** — Don't create Value Objects "just in case." If the DTO Zod schema handles validation and there's no domain behavior, the VO is dead code. PostVisibility and PostImage VOs were unnecessary.

5. **CQRS query pattern is superior for pure reads** — When no domain logic is needed (journal entries, streak counter, feed queries), direct Drizzle queries are simpler, faster, and require no DI ceremony. Reserve Use Case + Repository for commands and domain-logic reads.

6. **Input validation must be systematic** — Every controller endpoint needs Zod safeParse on ALL inputs (body, params, query). This was missed repeatedly and should be a checklist item.

## Technical Debt

| # | Item | Severity | Description |
|---|---|---|---|
| 1 | IEventDispatcher not wired | Medium | Domain events added to aggregates via `addEvent()` but never dispatched. Deferred to Epic 7 (Gamification Engine). |
| 2 | `<img>` instead of `<Image>` | Low | Pre-existing pattern using raw `<img>` tags for R2-hosted images instead of Next.js `<Image>` component. Requires R2 domain configuration in `next.config.js`. |
| 3 | `getAuthenticatedUser()` duplicated | Medium | Authentication helper function copy-pasted across 10+ controller files. Should be extracted to shared utility. |
| 4 | DATE() SQL timezone dependency | Low | PostgreSQL `DATE()` function in journal/streak queries depends on server timezone. Posts created near midnight may group on wrong date. Acceptable for single-user MVP. |
| 5 | db:push not executed | High | Database schema migration generated but never pushed to local PostgreSQL (database not running). Must resolve before deployment. |
| 6 | Pre-existing code duplication 8.77% | Low | conversation.repository.ts and mappers have duplication flagged by jscpd. Pre-existing, not introduced by Epic 1. |

## Action Items

| # | Action | Owner | Timeline | Success Criteria |
|---|---|---|---|---|
| 1 | Use explicit `: string` type annotation for VO.create() calls | Dev | Ongoing | Zero literal inference errors in future stories |
| 2 | Prefer imperative `isSome()`/`unwrap()` over async `match()` | Dev | Ongoing | Consistent pattern in all use cases |
| 3 | Don't create VOs without domain logic justification | Dev | Ongoing | Zero dead VOs created and removed in review |
| 4 | Validate ALL controller inputs with Zod safeParse | Dev | Ongoing | Every endpoint has input validation |
| 5 | Execute db:push when database is available | Dev | Before deployment | Schema applied to PostgreSQL |
| 6 | Extract getAuthenticatedUser() to shared utility | Dev | Before Epic 3 | Single source of truth, zero duplication |

## Epic 2 Preparation

### Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Post aggregate | Ready | Complete CRUD, events, ownership verification |
| Upload infrastructure | Ready | Shared endpoint operational |
| Friend module | Ready | Pre-existing brownfield module |
| Friend-based access control | Needs work | Architecture "Important Gap" — pattern to establish in Story 2.1 |
| Reaction domain | Needs design | Standalone entity vs sub-entity of Post — decision needed |
| IEventDispatcher | Not blocking | Events added but not dispatched (Epic 7 concern) |

### Dependencies on Epic 1

- Post aggregate with `isPrivate` flag — used by feed query to filter public-only posts ✅
- Post schema with `userId` — used to join with friend table for feed ✅
- Upload infrastructure — not directly needed for Epic 2 (no new uploads) ✅

### Preparation Tasks

1. **Design friend-based access control pattern** — How to verify friendship in feed queries. Likely a join on friend table in CQRS query.
2. **Design Reaction entity** — Standalone `reaction` table with `postId`, `userId`, `type` fields. Simple entity, not sub-entity of Post.
3. **No critical blockers** — Epic 2 can start immediately.

## Team Participants

- Bob (Scrum Master) — Facilitation
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical depth
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Fresh perspective
- Axel (Project Lead) — Oversight and direction

## Retrospective Verdict

Epic 1 was a strong foundation epic. 100% story completion, zero regressions, zero production incidents. The adversarial code review process proved its value by catching 2 security-critical issues. The team established solid patterns (Previous Story Intelligence, CQRS queries, aggregate design) that will carry forward. 6 technical debt items are documented and manageable. Epic 2 is ready to start with minimal preparation.
