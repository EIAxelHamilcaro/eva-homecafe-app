# Epic 3 Retrospective — Mood Tracking

**Date:** 2026-02-08
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 3 — Mood Tracking
**Status:** Complete (2/2 stories done)

## Epic Summary

Epic 3 delivered the complete mood tracking feature for HomeCafe, covering FR30-FR35 (6 functional requirements). The epic included daily mood recording with 9 categories and intensity slider, weekly day-by-day view, weekly bar chart, 6-month trend analysis, and mood legend. Fully standalone with zero dependencies on Epics 1 or 2.

### Delivery Metrics

- Stories completed: 2/2 (100%)
- Tests added: 29 new tests (166 → 195 total)
- Code reviews: 2 adversarial reviews, 18 issues found, 15 fixed, 3 deferred (LOW/i18n)
- Blockers: 0
- Production incidents: 0

### Stories Delivered

| Story | Description | Tests Added | Key Achievement |
|---|---|---|---|
| 3.1 | Record Daily Mood | 16 | New standalone mood domain, moodDate unique index (review fix), Result<MoodEntry> return type |
| 3.2 | View Mood History & Charts | 13 | 100% CQRS reads, Recharts via shadcn, mode() WITHIN GROUP SQL, zero domain code needed |

## What Went Well

1. **Security Checklist consistently applied (Epic 2 action item #1)** — Both stories include a complete "Security Checklist" section. Every endpoint verifies authentication, userId comes from session not request body. Zero access control issues found in review.

2. **Zero dead code created (Epic 2 action item #2)** — For the first time across 3 epics, no unnecessary class or file was created then removed in review. The "challenge specs before blind copying" action item from Epic 2 was fully internalized. Dev notes explicitly stated "MoodEntry is simpler than Post, no WatchedList, no images, no isPrivate."

3. **CQRS pattern maturity** — Story 3.2 was 100% read operations implemented as direct Drizzle CQRS queries. No use cases, no DI bindings, no repository methods needed. The team now fluently distinguishes commands from queries without hesitation.

4. **Standalone epic execution** — Epic 3 had zero dependencies on previous epics. No blocking concerns, no preparation overhead, immediate start. This is worth noting for future epic sequencing.

5. **Previous Story Intelligence works** — Lessons from Story 3.1 (shadcn npx fallback, import path fixes, Biome cleanup) were documented and successfully applied in Story 3.2. This cumulative learning mechanism prevents regression of known issues.

6. **Test suite growth and integrity** — 29 new tests added with zero regressions. Test suite grew from 166 to 195. All quality checks pass (type-check, Biome, tests).

7. **Recharts selection via shadcn** — Charting library research (Epic 2 action item #6) was completed. Recharts via `pnpm ui:add chart` provides consistent shadcn styling, React 19 compatibility, and SSR-friendly patterns.

## What Didn't Go Well

1. **HIGH severity issues still caught only in code review (3 consecutive epics)** — Story 3.1: race condition (missing unique index on userId+moodDate allowing duplicate entries). Story 3.1: MoodEntry.create() returned MoodEntry instead of Result<MoodEntry>. Story 3.2: N+1 query in mood-trends.query.ts. Story 3.2: double fetch of stats?period=week. This is the same pattern as Epics 1 and 2 — adversarial code review remains the only safety net for data integrity and performance issues.

2. **shadcn/ui install broken via turbo (2/2 stories)** — Both stories required fallback to `npx shadcn@latest add <component> --yes` from packages/ui directory. Both had incorrect import paths in generated files. Story 3.2's chart install overwrote card.tsx, breaking its imports. This is a recurring tooling issue.

3. **Two Epic 2 action items still not addressed (carried from Epic 1)** — `db:push` remains unexecuted (PostgreSQL not running locally). This has been unresolved for 3 epics. Schema migrations for mood, postReaction are generated but never pushed.

4. **i18n absent (new tech debt)** — UI text is in English despite the app targeting French users. formatMonth hardcoded to en-US locale, chart labels in English. 3 LOW issues deferred to a dedicated i18n story.

5. **Code duplication in chart components** — getMoodColor/getMoodLabel duplicated in 3 files before review caught it and extracted to mood-legend.tsx.

## Key Insights

1. **Security Checklist works — need equivalent for data integrity/performance** — The security checklist introduced in Epic 2 retro eliminated access control issues. The same approach should be applied to data integrity (unique constraints, indexes) and performance (N+1 detection, query efficiency).

2. **Standalone epics reduce risk** — Epic 3 had zero blocking concerns, zero preparation overhead, and immediate start capability. Future epic sequencing should prefer standalone epics when possible.

3. **Previous Story Intelligence is a multiplier** — Documenting lessons within story files and referencing them in subsequent stories demonstrably prevents regression of known issues and accelerates development.

4. **Event dispatcher needed** — Events have been accumulated via addEvent() since Epic 1 but never dispatched. A simple in-process synchronous dispatcher should be implemented in use cases, which are the orchestrators. This unblocks gamification (Epic 7).

5. **getAuthenticatedUser() duplication is acceptable** — Project Lead assessed this as a middleware-equivalent pattern. Not a priority for extraction. Removed from tech debt tracking.

## Previous Retrospective Follow-Through

### Epic 2 Action Items Status

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Security/access control checklist on every story | Completed | Both stories include "Security Checklist" section with all checks passed |
| 2 | Challenge specs before blind pattern copying | Completed | Zero dead code created in Epic 3 — first time across 3 epics |
| 3 | Extract `getAuthenticatedUser()` to shared utility | Dismissed | Project Lead assessed as middleware-equivalent pattern, acceptable duplication |
| 4 | Document friend-based access control in CLAUDE.md | N/A | Not applicable for mood tracker (standalone, no social features) |
| 5 | Execute db:push when database available | Not Addressed | PostgreSQL still not running locally |
| 6 | Research and select charting library for Epic 3 | Completed | Recharts via shadcn `pnpm ui:add chart` — React 19 compatible, consistent styling |

**Score: 3/6 completed, 1 dismissed, 1 N/A, 1 not addressed**

### Epic 2 Technical Debt Status

| # | Item | Epic 3 Status | Impact |
|---|---|---|---|
| 1 | IEventDispatcher not wired | Unchanged — scheduled for implementation | Events accumulated but not dispatched |
| 2 | `<img>` instead of `<Image>` | Unchanged | Pre-existing pattern |
| 3 | `getAuthenticatedUser()` duplicated | Dismissed | Assessed as acceptable middleware pattern |
| 4 | DATE() SQL timezone dependency | Replaced | moodDate column uses date type, no timezone |
| 5 | db:push not executed | Unchanged | mood schema added but not pushed |
| 6 | Pre-existing code duplication 8.77% | Unchanged | No impact |
| 7 | Biome warnings | Unchanged | 40 pre-existing warnings |

## Technical Debt

| # | Item | Severity | Description |
|---|---|---|---|
| 1 | IEventDispatcher not wired | High | Domain events added via addEvent() but never dispatched. Simple in-process dispatcher to be implemented in use cases. Unblocks gamification (Epic 7). |
| 2 | db:push not executed | High | Database schema migrations generated but never pushed (3 epics). |
| 3 | i18n absent | Low | UI text in English (formatMonth en-US, chart labels). Deferred to dedicated i18n story. |
| 4 | `<img>` instead of `<Image>` | Low | Pre-existing pattern using raw img tags. |
| 5 | Biome warnings | Low | 40 pre-existing warnings. |
| 6 | Pre-existing code duplication 8.77% | Low | conversation.repository.ts and mappers. |

## Action Items

| # | Action | Owner | Timeline | Success Criteria |
|---|---|---|---|---|
| 1 | Add data integrity/performance checklist to stories | SM (Bob) | Before Epic 4 | Every story includes: "Unique index needed?", "N+1 possible?", "DB-side vs app-side aggregation?" |
| 2 | Document shadcn/ui workaround in CLAUDE.md | Dev | Before Epic 4 | Section with: npx fallback, import path verification, card.tsx backup |
| 3 | Implement simple IEventDispatcher in use cases | Dev | During Epic 4 | In-process synchronous dispatcher, bound in DI, use cases call dispatchAll() after save |
| 4 | Continue Security Checklist (proven effective) | SM / Dev | Ongoing | Zero access control issues in review |
| 5 | Execute db:push when database available | Dev | Before deployment | All schemas applied to PostgreSQL |

## Epic 4 Preparation

### Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Board aggregate design | Needs design | Unified Board with Column and Card entities, 3 views (todo, kanban, chronology) |
| Drag & drop library | Needs research | @dnd-kit probable candidate, must confirm React 19 compat + 60fps (NFR6) |
| Calendar component | Needs research | For Story 4.3 chronology/timeline view |
| Event dispatcher | To implement | Simple in-process synchronous pattern in use cases |
| Dependencies on Epic 3 | None | Fully standalone |
| Technical infrastructure | Ready | CQRS + DI patterns mature |
| Test infrastructure | Ready | Vitest + existing patterns sufficient |

### Dependencies on Epic 3

None. Epic 4 (Organization) is fully standalone with no dependencies on Epic 3 work.

### Preparation Tasks

1. **Select drag & drop library** — Research @dnd-kit for React 19 compatibility, 60fps performance, and sortable/droppable features
2. **Select calendar component** — For chronology/timeline view (Story 4.3)
3. **Implement IEventDispatcher** — Simple in-process synchronous dispatcher, bound in DI, called from use cases after save

### Figma Reference

UI is dense but concepts are simple CRUD (Board/Column/Card):
- **Mobile:** Bottom tab bar, card-based todo lists, kanban columns with colored cards, chronology timeline
- **Desktop:** Sidebar nav, full kanban board with drag & drop, expanded calendar view
- **Tablet:** Hybrid layout, same features adapted

Screenshots: `.claude/screenshots/Mobile.png`, `.claude/screenshots/Desktop.png`, `.claude/screenshots/Tablet.png`

## Team Participants

- Bob (Scrum Master) — Facilitation
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical depth
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Fresh perspective
- Axel (Project Lead) — Oversight and direction

## Retrospective Verdict

Epic 3 was a clean, standalone epic. 100% story completion, 29 new tests with zero regressions, zero production incidents, and zero dead code (a first). The Security Checklist from Epic 2 proved its value. The recurring pattern of HIGH severity issues caught only in review led to a new action item: data integrity/performance checklist. The event dispatcher — accumulated since Epic 1 — will be implemented as a simple in-process pattern in use cases during Epic 4. Epic 4 (Organization) is fully standalone with dense UI but fundamentally simple CRUD concepts. The team is well-positioned for success.
