# Epic 6 Retrospective — Moodboard

**Date:** 2026-02-09
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 6 — Moodboard
**Status:** Complete (2/2 stories done)

## Epic Summary

Epic 6 delivered the complete Moodboard feature for HomeCafe, covering FR51-FR54. The epic introduced a Moodboard aggregate with nested Pin entities (image and color types), full CRUD operations, presigned URL upload for pin images, and a reactive UI with optimistic updates. Two stories, clean execution, zero blockers.

### Delivery Metrics

- Stories completed: 2/2 (100%)
- Tests added: 32 new tests (303 -> 335 total)
- Code reviews: 3 adversarial reviews, 12+ issues found (3 ERROR, 4+ WARNING), all fixed
- Blockers: 0
- Production incidents: 0

### Stories Delivered

| Story | Description | Tests Added | Files Created/Modified | Key Achievement |
|---|---|---|---|---|
| 6.1 | Create & Browse Moodboards | 7 | 29 created, 4 modified | Moodboard aggregate with Pin entity, 3 VOs, DB schema, CQRS queries, complete UI |
| 6.2 | Pin Items & Manage Moodboard Content | 25 | 16 created, 8 modified | AddPin/DeletePin/DeleteMoodboard use cases, full-sync repository, reactive UI with optimistic delete |

## What Went Well

1. **Clean execution: 2/2 stories, 0 blockers, 0 incidents** — Epic 6 maintained the streak of zero production incidents (now 6 consecutive epics). 100% FR coverage (FR51-54).

2. **Exemplary infrastructure reuse** — The upload endpoint from Epic 1 worked out of the box with `context: 'moodboard'`. Story 6.2 reused the entire foundation from 6.1 (aggregate, entity, VOs, repository, mappers, queries) without recreating a single component. Zero duplication.

3. **Well-designed aggregate with nested entity** — Pin as an Entity (not VO) was the correct design: it has identity, can be individually added/removed, but is always owned by the Moodboard aggregate. No separate Pin repository. The Board/Column/Card pattern from Epic 4 informed this design.

4. **Smart spec deviation: full-sync repository** — The dev agent deviated from the story spec (which called for addPin/deletePin methods) and used a full-sync approach (delete-all + re-insert in transaction). Simpler, atomic, and fully testable. Good engineering judgment.

5. **Reactive UI patterns** — refreshKey pattern for re-fetching after pin addition, combined with optimistic delete for instant feedback on pin removal. The UX feels responsive despite round-trip API calls.

6. **Previous retro follow-through: 2/3 complete, 1 partial** — shadcn workaround finally documented in CLAUDE.md (commit d16fad4). Retro item integration in stories continues working. Error handling visible checklist partially addressed (caught by code review but not explicitly in stories).

7. **32 new tests, zero regressions** — Comprehensive BDD coverage: 10 add-pin, 8 delete-pin, 7 delete-moodboard, 7 create-moodboard. All 335 tests passing.

## What Didn't Go Well

1. **HIGH severity issues found ONLY in code review — 6th consecutive epic** — Repository not loading pins in findByUserId (6.1-H2), aggregate encapsulation violation (6.2 review #2: direct `_props` mutation on child entity), AlertDialogAction auto-close bug (6.2 review #2). The adversarial code review remains the sole safety net.

2. **Aggregate encapsulation violation — first occurrence in project** — The Moodboard aggregate directly mutated `pin._props.position` instead of calling a method on the Pin entity. This is the first time this type of violation appeared in the project. Fixed by adding `Pin.updatePosition()` method.

3. **AlertDialogAction auto-close bug** — The shadcn AlertDialogAction closes the dialog on click by default. For async operations (delete moodboard), this meant errors became invisible — dialog closed before the API call completed. Fixed with `e.preventDefault()`. A subtle, framework-specific bug.

4. **Inconsistent return types in aggregate** — `markForDeletion()` returned `void` while `addPin()` and `removePin()` returned `Result<void>`. Inconsistency caught in code review #2 and fixed for pattern coherence.

5. **"Error handling visible" checklist not explicitly integrated** — Action item from Epic 5 retro. The stories don't include it as an explicit checklist item. The code review caught the AlertDialog issue, but the checklist was supposed to prevent it from reaching review.

## Key Insights

1. **Code review adversarial works — 6 epics, 0 production incidents** — The team consciously accepts this as the primary quality strategy. The cost of review is far lower than production bugs. However, the pattern of HIGHs-only-at-review should motivate better checklists.

2. **Aggregate encapsulation is a new checkpoint** — When aggregates own child entities, verify that the aggregate calls methods on the entity rather than mutating internal state. New class of issue to document.

3. **UI framework-specific bugs are a growing category** — AlertDialogAction auto-close, shadcn import paths, Zod 4 breaking changes. These are not logic bugs but framework-behavior bugs that require pattern documentation.

4. **Full-sync repository > granular methods for owned entities** — When child entities are always loaded with their parent, delete-all + re-insert in a transaction is simpler and safer than maintaining addChild/removeChild methods.

5. **Checklists in stories = followed. Standalone action items = fragile.** — Confirmed for the 4th consecutive epic. The mechanism: the dev agent follows what's IN the story context.

## Previous Retrospective Follow-Through

### Epic 5 Action Items Status

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Add "error handling visible" checklist to stories | Partial | Not explicitly in stories. Code review caught AlertDialog auto-close bug. |
| 2 | Document shadcn/ui workaround in CLAUDE.md | Complete | Commit d16fad4: "docs: document shadcn/ui import path workaround in CLAUDE.md" |
| 3 | Maintain retro item integration in story tasks | Complete | Both stories include "Previous Story Intelligence", checklists, golden reference files |

**Score: 2/3 completed, 1 partial**

### Epic 5 Technical Debt Status

| # | Item | Epic 6 Status | Impact |
|---|---|---|---|
| 1 | IEventDispatcher not wired | Unchanged — 3 new events added (PinAdded, PinRemoved, MoodboardDeleted) | Deferred to Epic 7 (will be core of Story 7.1) |
| 2 | db:push not executed | Unchanged — moodboard + pin table schema added | 6 epics of migrations not pushed |
| 3 | i18n absent | Unchanged | UI text in English |
| 4 | `<img>` instead of `<Image>` | Unchanged | Confirmed project pattern |
| 5 | Biome warnings | Unchanged | ~40 pre-existing warnings |

## Technical Debt

| # | Item | Severity | Description |
|---|---|---|---|
| 1 | IEventDispatcher not wired | High | Domain events added via addEvent() since Epic 1 (6 epics). Will be addressed in Epic 7. |
| 2 | db:push not executed | High | Database schema migrations generated but never pushed (6 epics). |
| 3 | i18n absent | Low | UI text in English. Deferred to dedicated story. |
| 4 | `<img>` instead of `<Image>` | Low | Pre-existing pattern using raw img tags. |
| 5 | Biome warnings | Low | ~40 pre-existing warnings. |

## Action Items

| # | Action | Owner | Timeline | Success Criteria |
|---|---|---|---|---|
| 1 | Add "aggregate encapsulation" checklist to stories with nested entities | Bob (SM) | Before Epic 7 | Every story with aggregate/entity includes: "Does the aggregate call methods on child entities instead of mutating _props?" |
| 2 | Integrate "error handling visible" checklist (carried from Epic 5) | Bob (SM) | Before Epic 7 | Every story includes: "Does every client-side API call have a visible error state + retry if applicable?" |
| 3 | Document AlertDialogAction async pattern | Bob (SM) | Before Epic 7 | Stories with AlertDialog + async operation include: "Use e.preventDefault() in AlertDialogAction onClick before async call" |

## Team Agreements

- Code review adversarial remains primary quality strategy — consciously accepted for 6th epic
- Checklists MUST be embedded in stories, not standalone action items
- Aggregate methods that can fail MUST return Result<void> for consistency
- Full-sync repository pattern preferred for owned entities over granular add/delete methods

## Epic 7 Preparation

### Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Upload infrastructure (Epic 1) | Ready | Reused successfully in Epic 6 |
| Aggregate + Entity pattern | Ready | Proven across 6 epics (Board, Photo, Moodboard) |
| CRUD + CQRS patterns | Ready | Mature across 6 epics |
| Domain Events | Ready (structure) | Events defined since Epic 1, dispatch deferred to Epic 7 |
| DI / Tests / Biome | Ready | 335 tests baseline, zero failures |
| Checklists | Updated | Security, data integrity, duplication, error handling, aggregate encapsulation |

### Dependencies on Epic 6

Minimal. Epic 7 will use MoodboardCreatedEvent and PinAddedEvent as achievement criteria inputs, but the primary dependency is on ALL domain events accumulated across Epics 1-6.

### Key Technical Challenge

Epic 7 is structurally different from all previous epics. It introduces an event-driven reactive system (IEventDispatcher + event handlers + achievement evaluation) rather than standard CRUD. Story 7.1 will be the most architecturally complex story in the project.

### No Significant Discoveries

Nothing from Epic 6 fundamentally changes the plan for Epic 7. The architecture is sound, patterns are proven, and the accumulated domain events are ready for dispatch wiring.

## Team Participants

- Bob (Scrum Master) — Facilitation
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical depth
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Fresh perspective
- Axel (Project Lead) — Oversight and direction

## Retrospective Verdict

Epic 6 delivered the complete Moodboard feature cleanly: 2 stories, 32 new tests, 57+ files created/modified, zero blockers, zero production incidents. The aggregate-with-nested-entity design (Moodboard/Pin) was well-executed, and the full-sync repository deviation was a smart engineering call. Infrastructure reuse from Epic 1 and Story 6.1 was exemplary. The 6th consecutive epic with HIGHs found only in code review confirms the adversarial review as the primary quality mechanism. New insights around aggregate encapsulation and AlertDialogAction async behavior have been captured as checklists for future stories. Epic 7 (Gamification) will be the most architecturally complex epic yet — event-driven reactive system — but the team has strong foundations and zero blockers.
