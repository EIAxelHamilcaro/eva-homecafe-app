# Epic 12 Retrospective — Mobile Visual: Gallery & Moodboards

**Date:** 2026-02-11
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 12 — Mobile Visual: Gallery & Moodboards
**Status:** Complete (2/2 stories done)

## Epic Summary

Epic 12 delivered mobile implementations of photo gallery and moodboard management, completing the visual content features on mobile. Both stories followed the TanStack Query patterns established in Epics 10-11 and introduced the first mobile file upload flow using presigned R2 URLs. A shared `upload-utils.ts` module was extracted to eliminate duplication between gallery and moodboard upload hooks. Zero backend modifications for the third consecutive epic, zero new libraries for the fourth consecutive epic.

### Delivery Metrics

- Stories completed: 2/2 (100%)
- Files created: 13 new files
- Files modified: 7 files
- Hooks created: ~10 TanStack Query hooks (gallery + moodboard CRUD + upload)
- Tests: 389 (0 new — mobile hooks tested via integration, no unit test additions)
- Code reviews: 2 adversarial reviews, 18 total issues (4H, 8M, 6L), all H+M fixed
- Review passes: 1 pass each (improvement over 11.2 which required 2)
- Blockers: 0
- Production incidents: 0 (12th consecutive epic)

### Stories Delivered

| Story | Description | Scope | Review Issues | Passes | Key Achievement |
|-------|-------------|-------|---------------|--------|-----------------|
| 12.1 | Photo Gallery Mobile | 4 tasks, 7 files | 10 (2H, 4M, 4L) | 1 | First mobile presigned URL upload flow, infinite scroll gallery |
| 12.2 | Moodboard Management Mobile | 5 tasks, 13 files | 8 (2H, 4M, 2L) | 1 | Cross-platform modal, color picker, shared upload-utils extraction |

## What Went Well

1. **Shared `upload-utils.ts` extraction** — Story 12.2 identified 40 lines of duplicated upload code between gallery and moodboard hooks. Instead of copying, the team extracted a shared utility module. This proactive refactoring reduces debt for all future upload features and demonstrates growing architectural maturity.

2. **Cross-platform awareness improved** — Story 12.2 used `Modal` + `TextInput` for moodboard creation instead of `Alert.prompt` (iOS-only). This prevents silent failures on Android and shows the team is thinking cross-platform by default.

3. **Single review pass per story** — Both stories needed only 1 review pass, an improvement over 11.2 which required 2 passes. The scope limit (max 3 views per story) from Epic 11's action items was respected: 12.1 had 1 view, 12.2 had 2 views.

4. **Zero backend modifications (3rd consecutive epic)** — The REST API contract continues to work seamlessly across web and mobile, further validating the API-first architecture.

5. **Zero new libraries (4th consecutive epic)** — The predefined color palette approach for moodboard pins avoided a color picker dependency. TanStack Query, expo-image-picker, and all existing libraries were sufficient.

6. **Clean implementations with minimal debug issues** — Story 12.2 had zero debug log entries. Story 12.1 had only minor Biome import cleanup. The codebase stability continues to improve.

7. **First mobile upload flow successfully implemented** — The 3-step presigned URL flow (request → XHR PUT to R2 with progress → register) was implemented cleanly with proper abort mechanisms and progress tracking.

## What Didn't Go Well

1. **`useInfiniteQuery` omission in BOTH stories (H1 x2)** — The most critical recurring issue. Story 12.1 H1: gallery showed only page 1 (first 20 photos). Story 12.2 H1: moodboard list showed only first 20 items. Same bug, same root cause, same fix needed in both stories. This is the "looks correct vs works correctly" pattern appearing for the **3rd consecutive epic** (10, 11, 12). The story spec code examples used `useQuery` which was directly copied, masking the pagination bug.

2. **Client-side validation systematically missing** — Three separate validation gaps across 2 stories: 12.1 H2 (no file size 10MB check), 12.1 M2 (no MIME type validation), 12.2 M2 (zero-byte file size bypass via `fileSize ?? 0`). The implementation consistently trusts the backend to validate, providing no immediate user feedback for invalid inputs.

3. **Epic 11 Action Item #1 not implemented** — The "AC-by-AC functional verification checklist" was the key action item from Epic 11 designed to combat the "looks correct" pattern. It was not added to either story spec. This is a direct cause of the recurring H1 bug — had the dev been required to verify "does pagination work beyond 20 items?", the bug would have been caught pre-review.

4. **Action item follow-through dropped from 100% to 60%** — Epic 11 achieved 3/3 (100%) on action items. Epic 12 achieved 3/5 (60%) — with the most impactful item being the one not addressed.

5. **UX feedback and visual states still missing in initial implementation** — 12.1 M4 (showToast instead of Alert.alert), 12.2 M3 (no visual feedback during delete), 12.2 M4 (no color preview for hex input). This is the 4th consecutive epic where secondary UX states are omitted in first implementation.

## Key Insights

1. **Action items not followed have direct, measurable consequences** — Epic 11's unfollowed Action Item #1 (functional verification checklist) directly caused Epic 12's most critical recurring bug (H1 in both stories). This proves the retrospective process works bidirectionally: followed items produce improvement (Epic 11's 100% follow-through improved story specs), unfollowed items allow regression.

2. **Story spec code examples become production code** — The `useQuery` examples in story templates were directly copied into implementation, masking the pagination bug. Code examples in specs are not illustrative — they are prescriptive. They must use the correct patterns (`useInfiniteQuery` for lists).

3. **"Looks correct vs works correctly" is a 3-epic systemic issue** — This is not a one-off or even a two-off. Three consecutive epics with the same pattern. The root cause is the mock-data-first workflow combined with visual-only verification. The fix must be structural (checklist), not just awareness.

4. **Client-side validation is a separate concern from backend validation** — The team consistently relies on backend validation alone. Client-side validation serves a different purpose: immediate user feedback, bandwidth savings on mobile, and graceful error UX. It should be treated as a first-class requirement.

5. **Proactive refactoring during implementation reduces debt** — The `upload-utils.ts` extraction in 12.2 demonstrates that refactoring during story work (not as separate debt stories) is the most effective approach. The team recognized duplication and acted immediately.

## Previous Retrospective Follow-Through

### Epic 11 Action Items Status

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Add AC-by-AC functional verification checklist to story template | ❌ Not addressed | No "Functional Verification Checklist" section in 12.1 or 12.2 specs. H1 bug recurred in both stories as a direct consequence. |
| 2 | Add error states + user feedback as standard review checklist items | ⏳ Partial | Guardrails #13/#14 in specs cover Alert.alert, but no formal review checklist. Review still caught issues (M3, M4 in 12.2). |
| 3 | Limit story scope to max 3 tabs/views per story | ✅ Completed | 12.1 = 1 view (gallery grid), 12.2 = 2 views (list + detail). Both within limit. |
| 4 | Document mobile upload flow before Epic 12 | ✅ Completed | Both story specs include detailed 3-step presigned URL flow documentation with code examples. |
| 5 | Update sprint-status.yaml: epic-11 → done | ✅ Completed | Sprint status shows epic-11: done. |

**Score: 3/5 completed, 1 partial, 1 not addressed (down from 3/3 = 100% in Epic 11)**

### Epic 11 Technical Debt Status

| # | Item | Epic 12 Status | Impact |
|---|---|---|---|
| 1 | db:push not executed | Worsened | Now 12 epics of migrations not pushed. |
| 2 | DeleteAccountUseCase missing | Unchanged | Tracked for Epic 15. |
| 3 | /og-landing.png missing | Unchanged | Tracked for Epic 15. |
| 4 | i18n not wired | Unchanged | Tracked for Epic 15. |
| 5 | Rich text as plain text in widget | Unchanged | Dashboard concern. |
| 6 | Mobile hooks have zero unit tests | Worsened | 15+ → 20+ hooks with zero tests. |
| 7 | useMoodStats hook unused (dead code) | Unchanged | May be needed for Epic 13 dashboard. |
| 8 | MoodWeekEntry.dayOfWeek typed as string | Unchanged | Low risk. |

## Technical Debt

| # | Item | Severity | Description |
|---|---|---|---|
| 1 | db:push not executed | Medium | Database schema migrations generated but never pushed (12 epics). |
| 2 | DeleteAccountUseCase missing | Medium | Tracked for Epic 15. |
| 3 | /og-landing.png missing | Medium | Tracked for Epic 15. |
| 4 | i18n not wired | Low | Tracked for Epic 15. |
| 5 | Rich text as plain text in widget | Low | Dashboard concern. |
| 6 | Mobile hooks have zero unit tests | Medium | 20+ TanStack Query hooks with zero test coverage. Risk grows each epic. |
| 7 | useMoodStats hook unused (dead code) | Low | May be needed for Epic 13 dashboard. |
| 8 | MoodWeekEntry.dayOfWeek typed as string | Low | Should be union type, low risk. |
| 9 | PinPreview/PinThumbnail component duplication | Low | Co-located with screens; extraction adds coupling for minimal benefit. |
| 10 | Inline style objects in moodboard list items | Low | Minimal performance impact for typical sizes. |

## Action Items

| # | Action | Owner | Success Criteria |
|---|---|---|---|
| 1 | IMPLEMENT the AC-by-AC functional verification checklist in story template (CARRIED OVER from Epic 11 — NON-NEGOTIABLE) | Bob (SM) | Every story spec contains a "Functional Verification Checklist" section with one checkbox per AC. Dev must verify each AC functionally (not visually) before requesting review. This item has been carried over once already — it MUST be done for Epic 13. |
| 2 | Replace `useQuery` with `useInfiniteQuery` as default pattern in story template for all paginated lists | Bob (SM) | Story template code examples use `useInfiniteQuery` + `FlatList` + `onEndReached` for any list endpoint. `useQuery` reserved for single-item reads only. |
| 3 | Add "Client-Side Validation Checklist" section to story template | Bob (SM) | Every story involving user inputs (upload, form, etc.) explicitly lists front-end validations: file size, format, null/zero values, limits. |
| 4 | Update sprint-status.yaml: epic-12 → done | Bob (SM) | Sprint status reflects completed epic. |

## Team Agreements

- The AC-by-AC functional verification checklist is MANDATORY — no longer optional, carried over twice
- `useInfiniteQuery` is the default for all paginated list data — `useQuery` only for single reads
- Client-side validation BEFORE every API call involving user inputs — file size, format, null checks
- Story scope limited to 3 views/tabs maximum — split larger stories proactively
- Code examples in story specs must use correct production patterns (not simplified examples)
- All Epic 10 and 11 agreements remain in force (pagination strategy, cache invalidation matrix, API contract verification, error states mandatory)

## No Significant Discoveries

Nothing from Epic 12 fundamentally changes architectural decisions for Epic 13. The mobile-consumes-backend pattern continues to validate. TanStack Query patterns are thoroughly established (20+ hooks across 3 epics). The shared `upload-utils.ts` extraction is a positive architectural evolution but doesn't change direction. The presigned URL upload flow works correctly and is reusable for any future upload feature.

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | ✅ Clean | 389 tests, 0 regressions, 0 Biome errors |
| Deployment | ⚠️ Never deployed | 12 epics without production deployment |
| Stakeholder Acceptance | N/A | Mobile phase in progress |
| Technical Health | ✅ Solid | 20+ hooks consistent, shared upload-utils extracted |
| Unresolved Blockers | ✅ None | All H+M review findings resolved |
| Mobile Hook Testing | ⚠️ Gap growing | 20+ hooks with zero unit tests |

## Next Steps — Epic 13 Preparation

**Epic 13: Mobile Gamification & Dashboard**

Two stories planned:
1. **13.1: Stickers & Badge Collections (Mobile)** — Connect sticker/badge screens to `/api/v1/rewards`. Placeholder screens with existing UI components.
2. **13.2: Dashboard Widgets — Real API Connection (Mobile)** — Replace mock data in dashboard widgets with real API calls. Some widgets may already be connected from previous epics.

**Preparation Tasks:**
- [ ] Audit dashboard widgets — verify which still use mock data vs already connected to API
- [ ] Study rewards API contract (endpoints, DTOs, earned vs available model)
- [ ] Evaluate 13.2 scope — if more than 3 widgets need connection, split into 2 stories
- [ ] Update sprint-status.yaml: epic-12 → done
- [ ] Integrate Action Items #1-3 into story template BEFORE creating Epic 13 stories

**Key Risks for Epic 13:**
- 13.2 scope potentially too large (8 widgets, though some may already be connected)
- Rewards/stickers have a different data model (earned vs available, criteria-based)
- No upload work in Epic 13 (context shift, but simpler)

**Recommendations from Epic 12 learnings:**
- Apply Action Item #1: include functional verification checklist — THIS TIME FOR REAL
- Apply Action Item #2: use `useInfiniteQuery` default in code examples
- Apply Action Item #3: client-side validation checklist for any input-based features
- Audit widgets before writing 13.2 spec to right-size the scope

## Team Participants

- Bob (Scrum Master) — Facilitation
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical depth
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Fresh perspective
- Axel (Project Lead) — Oversight and direction

## Retrospective Verdict

Epic 12 successfully delivered photo gallery and moodboard management on mobile with zero backend modifications (3rd consecutive epic) and zero new libraries (4th consecutive). The highlight is the shared `upload-utils.ts` extraction — proactive refactoring that reduces debt for all future uploads. The main concern is the persistent "looks correct vs works correctly" pattern appearing for the 3rd consecutive epic, producing the same H1 bug (missing `useInfiniteQuery`) in BOTH stories. This is directly linked to Epic 11's unfollowed Action Item #1 (functional verification checklist), proving that retrospective follow-through has measurable consequences. Three new action items target the root causes: mandatory functional verification checklist (carried over — non-negotiable), `useInfiniteQuery` as default pattern, and client-side validation checklist. With 20+ hooks, 389 stable tests, and a maturing upload architecture, the codebase is solid. The team is ready for Epic 13 pending widget audit and story template updates.
