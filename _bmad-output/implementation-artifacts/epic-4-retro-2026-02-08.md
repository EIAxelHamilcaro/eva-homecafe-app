# Epic 4 Retrospective — Organization (Todo, Kanban, Timeline)

**Date:** 2026-02-08
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 4 — Organization (Todo, Kanban, Timeline)
**Status:** Complete (3/3 stories done)

## Epic Summary

Epic 4 delivered the complete organization feature for HomeCafe, covering FR36-FR42. The epic introduced a unified Board aggregate model serving three interchangeable views: todo lists with checkable items, kanban boards with drag & drop, and a chronology/timeline calendar view. The Board/Column/Card domain model was designed once in Story 4.1 and extended without schema changes through Stories 4.2 and 4.3.

### Delivery Metrics

- Stories completed: 3/3 (100%)
- Tests added: 92 new tests (195 → 287 total)
- Code reviews: 3 adversarial reviews, 31 issues found (9 HIGH, 16 MEDIUM, 6 LOW), all fixed
- Blockers: 0
- Production incidents: 0

### Stories Delivered

| Story | Description | Tests Added | Files Created | Key Achievement |
|---|---|---|---|---|
| 4.1 | Create & Manage Todo Lists | 34 | 35 | Unified Board aggregate model, full CRUD, DB schema, DI wiring |
| 4.2 | Kanban Boards with Drag & Drop | 50 | 28 | @dnd-kit drag & drop, optimistic UI, CardCompletedEvent, 5 new use cases |
| 4.3 | Chronology / Timeline View | 8 | 9 | Pure CQRS read, shadcn Calendar, colored event dots, zero domain changes |

## What Went Well

1. **Unified Board model — architecture success** — A single Board aggregate with Column[] and Card[] entities serves all 3 views (todo, kanban, chronology) with zero domain duplication. Designed in 4.1, extended without schema changes in 4.2, and consumed read-only in 4.3. This is the most elegant domain model in the project.

2. **Perfect story sequencing** — Stories progressed naturally: 4.1 (foundation: domain + schema + CRUD), 4.2 (extension: DnD + new methods), 4.3 (read-only: CQRS query). Each story built on the previous without friction or rework. Story complexity decreased as foundations strengthened.

3. **Data integrity + security checklists proven effective (Epic 3 action items #1, #4)** — Every story included both checklists. Zero N+1 queries in production code. Zero access control issues found in review. Auth guard restoration in 4.2 (H1) was caught precisely because the security checklist was being followed.

4. **Previous Story Intelligence is a multiplier** — Each story documented pitfalls for the next: `board_column` naming, shadcn import fixes, repository patterns, DDD Option/Result usage. Story 4.3 referenced 10 specific learnings from 4.2. This prevents regression of known issues.

5. **CQRS maturity** — Story 4.3 was 100% CQRS read: zero domain entities, zero use cases, zero DI registrations, zero schema changes. The team fluently executed a pure query pattern (JOIN card → boardColumn → board) without any confusion about when to use queries vs use cases.

6. **@dnd-kit integration with optimistic UI** — Drag & drop runs at 60fps with local state updates and background server sync. @dnd-kit v6/v10 works well with React 19. The DndContext/SortableContext/DragOverlay pattern is clean and extensible.

7. **92 tests with zero regressions** — Largest test addition in any epic. Suite grew from 195 to 287. All quality checks pass (type-check, Biome, tests).

## What Didn't Go Well

1. **HIGH severity issues found ONLY in code review — 4 consecutive epics** — 9 HIGH issues across 3 stories: type filter corrupting pagination (4.1-H1), missing pgEnum (4.1-H5), auth guard lost on server→client conversion (4.2-H1), full board list refetch on every drag (4.2-H2), tests not verifying query arguments (4.3-H7). The adversarial code review remains the sole safety net. No pre-submission checks catch these issues.

2. **shadcn import paths broken on EVERY installation — 11 files across 3 stories** — 4.1: tabs, dialog, alert-dialog, button. 4.2: dropdown-menu, popover, progress, textarea. 4.3: calendar, button, separator. All required manual fix from `/src/libs/utils` to `../../libs/utils`. This was an action item from Epic 3 retro (document workaround in CLAUDE.md) and was NOT addressed.

3. **3/5 Epic 3 retro action items not addressed** — shadcn workaround documentation, IEventDispatcher implementation, and db:push execution all carried forward unchanged. Only the checklists (integrated into stories) were followed. Standalone action items are not tracked.

4. **Code duplication systematically caught only in review** — 4.1: shared DTOs and mapper extracted (M7, M8). 4.2: syncBoard replaced with applyBoardResponse (H2). 4.3: isOverdue moved out of component, formatDateKey memoized. The dev agent produces functional but duplicated code that requires review to clean up.

5. **Auth guard almost lost in 4.2** — When page.tsx was converted from server to client component for DnD, `requireAuth()` silently disappeared. This was a security regression caught only in adversarial review (H1). The fix was creating a layout.tsx with the guard.

## Key Insights

1. **Checklists integrated into stories work; standalone action items don't** — Security checklist and data integrity checklist (embedded in story Dev Notes) are consistently followed. But action items that require separate effort (document shadcn fix, implement dispatcher) are ignored. Solution: convert all action items into story tasks or checklist items.

2. **A "code duplication" checklist would catch half the MEDIUM review issues** — Every review extracted shared code. A pre-submission check ("Are there duplicated DTOs? Shared mappers? Extracted helpers?") would catch these before review.

3. **Server→client component conversion is a security risk vector** — The auth guard loss in 4.2 is the most dangerous pattern discovered. When a server component becomes a client component, guards in the component itself silently disappear. Auth must always live in layout.tsx, never in page.tsx.

4. **The Board model design was right from day one** — Zero refactoring needed across 3 stories. The architecture decision to use one aggregate for 3 views paid off enormously. This validates the upfront design investment.

5. **IEventDispatcher accumulation is a conscious trade-off** — Events have been added via addEvent() since Epic 1 (5 epics now). CardCompletedEvent added in 4.2. The decision to defer dispatch to Epic 7 is rational but should be explicitly acknowledged, not left ambiguous.

## Previous Retrospective Follow-Through

### Epic 3 Action Items Status

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Data integrity/performance checklist on every story | ✅ Completed | All 3 stories include checklist sections with N+1, race condition, performance analysis |
| 2 | Document shadcn/ui workaround in CLAUDE.md | ❌ Not Addressed | No CLAUDE.md section added. Same fix applied manually 11 times across 3 stories |
| 3 | Implement IEventDispatcher in use cases | ❌ Not Addressed | CardCompletedEvent added in 4.2 via addEvent() but dispatcher still not wired |
| 4 | Continue Security Checklist | ✅ Completed | Zero access control issues. Auth guard restored in 4.2 thanks to checklist vigilance |
| 5 | Execute db:push when database available | ❌ Not Addressed | PostgreSQL still not running locally. 4 epics of schemas not pushed |

**Score: 2/5 completed, 3 not addressed**

### Epic 3 Technical Debt Status

| # | Item | Epic 4 Status | Impact |
|---|---|---|---|
| 1 | IEventDispatcher not wired | Unchanged — more events added (CardCompletedEvent) | Events accumulating, dispatch deferred to Epic 7 |
| 2 | db:push not executed | Unchanged | 4 epics of schema migrations not pushed |
| 3 | i18n absent | Unchanged | UI text still in English |
| 4 | `<img>` instead of `<Image>` | Unchanged | Pre-existing pattern |
| 5 | Biome warnings | Unchanged | 40 pre-existing warnings |
| 6 | Pre-existing code duplication 8.77% | Unchanged | No impact |

## Technical Debt

| # | Item | Severity | Description |
|---|---|---|---|
| 1 | IEventDispatcher not wired | High | Domain events added via addEvent() since Epic 1 (5 epics). CardCompletedEvent, BoardCreatedEvent, etc. accumulating. Deferred to Epic 7. |
| 2 | db:push not executed | High | Database schema migrations generated but never pushed (4 epics). All schemas: user, post, profile, friend, notification, postReaction, moodEntry, board, boardColumn, card. |
| 3 | i18n absent | Low | UI text in English. formatMonth en-US, chart labels, calendar locale. Deferred to dedicated story. |
| 4 | `<img>` instead of `<Image>` | Low | Pre-existing pattern using raw img tags. |
| 5 | Biome warnings | Low | 40 pre-existing warnings (dangerouslySetInnerHTML, noNonNullAssertion in tests). |
| 6 | shadcn import paths | Low | Every shadcn install requires manual import path fix. Tooling issue, not code debt. |

## Action Items

| # | Action | Owner | Timeline | Success Criteria |
|---|---|---|---|---|
| 1 | Add code duplication checklist to stories | SM (Bob) | Before Epic 5 | Every story includes: "Shared DTOs exist? Mapper reusable? Helper already extracted?" |
| 2 | Document shadcn/ui workaround in CLAUDE.md | Dev (Amelia) | Before Epic 5 | CLAUDE.md section with: npx fallback command, import path fix pattern, backup instructions |
| 3 | Add server→client conversion check to Security Checklist | SM (Bob) | Before Epic 5 | Checklist item: "If page converted to client component, verify auth guard in layout.tsx" |
| 4 | Integrate retro action items into story tasks | SM (Bob) | Ongoing | No standalone action items — all converted to story checklist items or tasks |
| 5 | IEventDispatcher: Explicitly accept deferral to Epic 7 | Axel (Project Lead) | Decision needed | Clear decision documented: implement now or accept deferral with rationale |

## Epic 5 Preparation

### Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Upload infrastructure (Story 1.1) | Needs verification | Shared upload from Epic 1 — verify still functional |
| Photo domain design | Straightforward | Simple aggregate: Photo with userId, url, caption, createdAt |
| Dependencies on Epic 4 | None | Fully standalone |
| Dependencies on Epic 1 | Shared upload | File upload infrastructure from Story 1.1 |
| Technical infrastructure | Ready | CQRS + DI + domain patterns mature |
| Test infrastructure | Ready | 287 tests, Vitest patterns established |
| Storage/S3 integration | Needs assessment | May need real storage testing eventually |

### Dependencies on Epic 4

None. Epic 5 (Photo Gallery) is fully standalone with no dependencies on Epic 4 work.

### Preparation Tasks

1. **Verify upload infrastructure from Story 1.1** — Ensure shared file upload is still functional and tested
2. **Document shadcn workaround in CLAUDE.md** — Finally resolve this 2-epic-old action item

## Team Participants

- Bob (Scrum Master) — Facilitation
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical depth
- Dana (QA Engineer) — Quality & testing
- Elena (Junior Dev) — Fresh perspective
- Axel (Project Lead) — Oversight and direction

## Retrospective Verdict

Epic 4 was the most ambitious epic to date: 3 stories, 92 tests, 72 files created, and a unified Board aggregate model that elegantly serves 3 views. 100% story completion with zero blockers and zero production incidents. The data integrity and security checklists from Epic 3 retro proved their value — zero N+1 queries, zero access control issues in production code. However, the pattern of HIGH severity issues found only in adversarial review continues (4 consecutive epics, 9 HIGH this epic). The key insight is that checklists embedded in stories are followed, but standalone action items are not. Epic 5 (Photo Gallery) is standalone, straightforward, and has no critical blockers. The team is well-positioned for success.
